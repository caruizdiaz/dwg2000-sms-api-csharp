// 
// Main.cs by Carlos Ruiz Díaz
// carlos.ruizdiaz@gmail.com
// 9/18/2012, Asunción - Paraguay
// 

using System;
using System.Runtime.InteropServices;
using System.Security;

namespace dwgsms
{
	class MainClass
	{
		
		class managed
		{
			public int a;
			
			public void print(int a)
			{
				Console.WriteLine(a);
			}
		}
		
		[StructLayout(LayoutKind.Sequential)]
		public struct str_t
		{
			public string s;
			public int len;
		}
		
		[StructLayout(LayoutKind.Sequential)]		
		public unsafe struct dwg_port_status
		{
			public int port;
			public int status;
		};
		
		[StructLayout(LayoutKind.Sequential)]		
		public unsafe struct dwg_ports_status
		{
			public int size;			
//			[MarshalAs(UnmanagedType.SafeArray)]
			public dwg_port_status* status_array;
		};
		
		public delegate void cb(int a, ref str_t b);
		public delegate void cb2(int a, ref dwg_ports_status b);
		public delegate void cb3(IntPtr sts);
		
		[DllImport("libdwgsms.pub.so")]
		public static extern int print_something(string str);
				    	
  		[DllImport("libdwgsms.pub.so")]
		public static extern void make_cb(cb callback);
					
		[DllImport("libdwgsms.pub.so")]
		public static extern void make_cb2(cb2 callback);
		
		[DllImport("libdwgsms.pub.so")]
		public static extern void make_cb3(IntPtr sts);
		
		[DllImport("libdwgsms.pub.so")]
		public static extern void make_cb4(cb3 callback);
		
/*		public static void Main (string[] args)
		{
			Console.WriteLine ("Hello World!");			
			managed m = new managed();
//			print_something("hola mundo!");
			
			
//			make_cb2(callback);

			//dwg_ports_status *sts =  (dwg_ports_status *) Marshal.AllocCoTaskMem(Marshal.SizeOf(typeof(dwg_ports_status)));
//			dwg_ports_status *sts =  (dwg_ports_status *) Marshal.AllocHGlobal(Marshal.SizeOf(typeof(dwg_ports_status)));
			
	/*		make_cb3((IntPtr) sts);
				
			Console.WriteLine(sts->size);
			
			//m.print(sts->size);
				
			Console.WriteLine(sts->status_array[1].port);
			Console.WriteLine(sts->status_array[1].status);
			
			Console.WriteLine(sts->status_array[2].port);
			Console.WriteLine(sts->status_array[2].status);
			
			Console.WriteLine("done");
			
			
			make_cb4(status_update);				
			
		}
		*/
		
		static void callback(int a, ref dwg_ports_status sts)
		{
			Console.WriteLine(a);
			Console.WriteLine(sts.size);
			
			//var structSize	= Marshal.SizeOf(typeof(dwg_ports_status))
			
		}
		
			//Marshal.FreeCoTaskMem(
	
		static unsafe void status_update(IntPtr ptr)
		{	
			//Marshal.PtrToStructure(ptr, typeof(dwg_ports_status));		
			Console.WriteLine("here");
			
			dwg_ports_status *sts = (dwg_ports_status *) ptr;
			
		//	Marshal.PtrToStructure((IntPtr) sts->status_array, typeof(dwg_port_status) * sts->size);		
			
			
			Console.WriteLine(sts->size);
			Console.WriteLine(sts->status_array[1].port);
			Console.WriteLine(sts->status_array[2].port);
			Console.WriteLine(sts->status_array[3].port);
			
			
		/*	make_cb2(delegate(int a, dwg_ports_status *asd) {
				
				Console.WriteLine(a);
					
			});*/		
		}
	
		
		
		
	}
}